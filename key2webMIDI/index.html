<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>オーディオループ＆ピッチシフター</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; }
        #status, #fileStatus { margin: 20px 0; }
        #controls { margin: 20px 0; }
        button { margin: 0 10px; padding: 10px 20px; font-size: 16px; }
    </style>
</head>
<body>
    <h1>オーディオループ＆ピッチシフター</h1>
    <div id="status">MIDIデバイスを接続してください</div>
    <div id="fileStatus">音声ファイルを選択してください</div>
    <input type="file" id="audioFileInput" accept="audio/*">
    <div id="controls">
        <button id="playButton" disabled>再生/停止</button>
        <button id="resetButton" disabled>リセット</button>
    </div>

    <script>
        let audioContext;
        let source;
        let audioBuffer;
        let isPlaying = false;
        let pitchShift = 1;

        // Web Audio APIのセットアップ
        function setupAudio() {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
        }

        // オーディオファイルの読み込み
        document.getElementById('audioFileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                audioContext.decodeAudioData(e.target.result, function(buffer) {
                    audioBuffer = buffer;
                    document.getElementById('fileStatus').textContent = 'ファイルが読み込まれました';
                    document.getElementById('playButton').disabled = false;
                    document.getElementById('resetButton').disabled = false;
                });
            };
            reader.readAsArrayBuffer(file);
        });

        // 再生/停止の切り替え
        document.getElementById('playButton').addEventListener('click', function() {
            if (isPlaying) {
                stopAudio();
            } else {
                playAudio();
            }
        });

        // オーディオの再生
        function playAudio() {
            source = audioContext.createBufferSource();
            source.buffer = audioBuffer;
            source.loop = true;

            const pitchShifter = audioContext.createScriptProcessor(4096, 1, 1);
            pitchShifter.onaudioprocess = function(e) {
                const inputBuffer = e.inputBuffer.getChannelData(0);
                const outputBuffer = e.outputBuffer.getChannelData(0);
                for (let i = 0; i < inputBuffer.length; i++) {
                    const index = i * pitchShift;
                    outputBuffer[i] = inputBuffer[Math.floor(index) % inputBuffer.length];
                }
            };

            source.connect(pitchShifter);
            pitchShifter.connect(audioContext.destination);
            source.start(0);
            isPlaying = true;
            document.getElementById('playButton').textContent = '停止';
        }

        // オーディオの停止
        function stopAudio() {
            if (source) {
                source.stop(0);
                isPlaying = false;
                document.getElementById('playButton').textContent = '再生';
            }
        }

        // リセットボタン
        document.getElementById('resetButton').addEventListener('click', function() {
            stopAudio();
            pitchShift = 1;
        });

        // MIDI入力の処理
        function onMIDISuccess(midiAccess) {
            for (var input of midiAccess.inputs.values()) {
                input.onmidimessage = getMIDIMessage;
            }
            document.getElementById('status').textContent = 'MIDIデバイスが接続されました';
        }

        function onMIDIFailure() {
            document.getElementById('status').textContent = 'MIDIデバイスの接続に失敗しました';
        }

        function getMIDIMessage(message) {
            const command = message.data[0];
            const note = message.data[1];
            const velocity = (message.data.length > 2) ? message.data[2] : 0;

            switch (command) {
                case 144: // noteOn
                    if (velocity > 0) {
                        pitchShift = Math.pow(2, (note - 60) / 12);
                    } else {
                        pitchShift = 1;
                    }
                    break;
                case 128: // noteOff
                    pitchShift = 1;
                    break;
            }
        }

        // Web MIDI APIの初期化
        if (navigator.requestMIDIAccess) {
            navigator.requestMIDIAccess()
                .then(onMIDISuccess, onMIDIFailure);
        } else {
            document.getElementById('status').textContent = 'このブラウザはMIDIをサポートしていません';
        }

        // セットアップ
        setupAudio();
    </script>
</body>
</html>